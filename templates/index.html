<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Bancaire - Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="app-container">
        <header id="main-header">
            <div class="logo-title">
                <span style="font-size: 1.5em;"></span> 
                <h1>Oraflex ChatBot</h1>
            </div>
            <div>
                <span id="user-name">{{ username }}</span>
                <a id="logout-button" href="{{ url_for('logout') }}">D√©connexion</a>
            </div>
        </header>

        <div id="chat-container">
            <div id="chat-display">
                <div class="bot-message">ü§ñ Bienvenue au Oraflex ChatBot votre assistant virtuel. Que puis-je faire pour vous ?</div>
                <button id="scroll-to-bottom" title="Aller en bas">‚¨á</button>
            </div>

            <div id="quick-actions">
                <button class="action-btn" data-action="Je veux consulter mon solde">üí∞ Mon solde</button>
                <button class="action-btn" data-action="Faire un virement">üí∏ Virement</button>
                <button class="action-btn" data-action="Historique">üìú Historique</button>
                <button class="action-btn" data-action="Aide">‚ùì Aide</button>
            </div>

            <div id="chat-input-area">
                <input type="text" id="user-input" placeholder="Posez votre question...">
                <button id="send-button">‚û§</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatDisplay = document.getElementById('chat-display');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const quickActionsContainer = document.getElementById('quick-actions');
        const scrollButton = document.getElementById('scroll-to-bottom');

        let userIsAtBottom = true;
        const SCROLL_THRESHOLD = 80;

        // --- Scroll automatique ---
        function checkIfAtBottom() {
            userIsAtBottom = (chatDisplay.scrollHeight - chatDisplay.scrollTop - chatDisplay.clientHeight) <= SCROLL_THRESHOLD;
            scrollButton.style.display = userIsAtBottom ? 'none' : 'block';
        }

        chatDisplay.addEventListener('scroll', checkIfAtBottom);
        scrollButton.addEventListener('click', (e) => {
            e.preventDefault();
            chatDisplay.scrollTo({ top: chatDisplay.scrollHeight, behavior: 'smooth' });
        });

        // --- Ajouter message ---
        function appendMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            if (sender === 'user') {
                messageDiv.classList.add('user-message');
            } else {
                messageDiv.classList.add('bot-message');
                text = 'ü§ñ ' + text;
            }
            const p = document.createElement('p');
            p.textContent = text;
            messageDiv.appendChild(p);
            chatDisplay.appendChild(messageDiv);

            if (sender === 'user' || userIsAtBottom) {
                try { chatDisplay.scrollTo({ top: chatDisplay.scrollHeight, behavior: 'smooth' }); } 
                catch(e) { chatDisplay.scrollTop = chatDisplay.scrollHeight; }
            }
        }

        // --- Envoi message au serveur Flask ---
        function sendMessage(message) {
            if (!message) return;
            if (userInput.value.trim() !== '') userInput.value = '';
            appendMessage(message, 'user');

            fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            })
            .then(response => response.json())
            .then(data => {
                const botResponse = data.response || "Je n'ai pas compris votre demande.";
                appendMessage(botResponse, 'bot');

                // ‚úÖ Dynamique : met √† jour les actions rapides selon l‚Äôintention d√©tect√©e
                updateQuickActions(data.intent || null);
            })
            .catch(error => {
                console.error('Erreur serveur:', error);
                appendMessage("ü§ñ Une erreur est survenue lors de la connexion.", 'bot');
            });
        }

        // --- Mise √† jour dynamique des boutons d‚Äôaction rapide ---
        function updateQuickActions(intent) {
            const actionsMap = {
                "solde": ["Voir transactions r√©centes", "Consulter solde √©pargne"],
                "virement": ["Virement interne", "Virement externe", "Annuler virement"],
                "historique": ["Derniers 5 mouvements", "Mouvements par date"],
                "aide": ["FAQ", "Contacter support", "Conseils s√©curit√©"],
                "autre": ["üí∞ Mon solde", "üí∏ Virement", "üìú Historique", "‚ùì Aide"]
            };

            const actions = actionsMap[intent] || actionsMap["autre"];
            quickActionsContainer.innerHTML = "";
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.classList.add('action-btn');
                btn.textContent = action;
                btn.dataset.action = action;
                btn.addEventListener('click', () => sendMessage(action));
                quickActionsContainer.appendChild(btn);
            });
        }

        // --- √âv√©nements input et boutons ---
        sendButton.addEventListener('click', () => sendMessage(userInput.value.trim()));
        userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(userInput.value.trim()); });

        // Scroll automatique avec observer
        const observer = new MutationObserver(() => { if (userIsAtBottom) chatDisplay.scrollTop = chatDisplay.scrollHeight; });
        observer.observe(chatDisplay, { childList: true, subtree: true });

        // Scroll initial
        chatDisplay.scrollTop = chatDisplay.scrollHeight;
        checkIfAtBottom();
    });
    </script>
</body>
</html>
